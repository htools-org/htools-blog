<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>HNS + PowerDNS + Nginx + DANE - Part 1 | Handshake Tools Blog</title>
<meta name=keywords content>
<meta name=description content="Posts in this series:
 Introduction Part 1 - Set up DNS server (this one!) Part 2 - Set up Web server Part 3 - Secure with DANE   Set up DNS server We&rsquo;ll be using PowerDNS here. You can use bind9, knot, or any other authoritative server, but PowerDNS is the (personally) easiest to set up and use.
 Sebastian Rasor has a similar guide with nsd: https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane">
<meta name=author content="Rithvik Vibhu">
<link rel=canonical href=https://blog.htools.work/posts/hns-pdns-nginx-part-1/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.htools.work/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blog.htools.work/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blog.htools.work/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blog.htools.work/apple-touch-icon.png>
<link rel=mask-icon href=https://blog.htools.work/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.90.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-214306612-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="HNS + PowerDNS + Nginx + DANE - Part 1">
<meta property="og:description" content="Posts in this series:
 Introduction Part 1 - Set up DNS server (this one!) Part 2 - Set up Web server Part 3 - Secure with DANE   Set up DNS server We&rsquo;ll be using PowerDNS here. You can use bind9, knot, or any other authoritative server, but PowerDNS is the (personally) easiest to set up and use.
 Sebastian Rasor has a similar guide with nsd: https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.htools.work/posts/hns-pdns-nginx-part-1/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-26T00:00:00+05:30">
<meta property="article:modified_time" content="2021-11-26T00:00:00+05:30">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="HNS + PowerDNS + Nginx + DANE - Part 1">
<meta name=twitter:description content="Posts in this series:
 Introduction Part 1 - Set up DNS server (this one!) Part 2 - Set up Web server Part 3 - Secure with DANE   Set up DNS server We&rsquo;ll be using PowerDNS here. You can use bind9, knot, or any other authoritative server, but PowerDNS is the (personally) easiest to set up and use.
 Sebastian Rasor has a similar guide with nsd: https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.htools.work/posts/"},{"@type":"ListItem","position":2,"name":"HNS + PowerDNS + Nginx + DANE - Part 1","item":"https://blog.htools.work/posts/hns-pdns-nginx-part-1/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HNS + PowerDNS + Nginx + DANE - Part 1","name":"HNS \u002b PowerDNS \u002b Nginx \u002b DANE - Part 1","description":"Posts in this series:\n Introduction Part 1 - Set up DNS server (this one!) Part 2 - Set up Web server Part 3 - Secure with DANE   Set up DNS server We\u0026rsquo;ll be using PowerDNS here. You can use bind9, knot, or any other authoritative server, but PowerDNS is the (personally) easiest to set up and use.\n Sebastian Rasor has a similar guide with nsd: https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane","keywords":[],"articleBody":"Posts in this series:\n Introduction Part 1 - Set up DNS server (this one!) Part 2 - Set up Web server Part 3 - Secure with DANE   Set up DNS server We’ll be using PowerDNS here. You can use bind9, knot, or any other authoritative server, but PowerDNS is the (personally) easiest to set up and use.\n Sebastian Rasor has a similar guide with nsd: https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane\n Disable Stub Resolver First things first, Ubuntu comes with systemd’s stub resolver listening on port 53, which we’ll need to stop / free up.\n# check if the DNS port is already bound to by systemd-resolve sudo lsof -i :53 # if the output is empty, the stub resolver is already disabled, skip this section. With your favorite text editor, open /etc/systemd/resolved.conf with sudo and:\n Set DNS=1.1.1.1 (or any other public resolver to be used by the system) Uncomment and set DNSStubListener=no  Symlink this file to use systemd’s resolv config:\nsudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf Then reboot the machine with sudo reboot. Check with lsof again and make sure systemd-resolve is not listed.\n If you see sudo complaining warning about hostname not resolving every time it is used, edit /etc/hosts to add a line 127.0.0.1 hostname where hostname is the hostname of the machine. This won’t affect any commands below and is entirely optional.\n Install PowerDNS This is straight-forward and same as PowerDNS install docs:\n# Add PowerDNS repo from https://repo.powerdns.com/ (select OS, Authoritative Server, latest version) sudo sh -c \"echo 'deb [arch=amd64] http://repo.powerdns.com/ubuntu focal-auth-46 main'  /etc/apt/sources.list.d/pdns.list\" sudo sh -c \"echo 'Package: pdns-*\\nPin: origin repo.powerdns.com\\nPin-Priority: 600'  /etc/apt/preferences.d/pdns\" curl https://repo.powerdns.com/FD380FBB-pub.asc | sudo apt-key add - sudo apt update # Install PowerDNS and sqlite3 backend (which is good enough for most cases) sudo apt install sqlite3 pdns-server pdns-backend-sqlite3 -y The server must have started by now, confirm that the Active: is active(running) in green on\nsudo systemctl status pdns Configure PowerDNS With the server now installed, we’ll update its configuration file /etc/powerdns/pdns.conf and set these fields:\n(remember to remove the existing launch line in the file)\nlaunch=gsqlite3 gsqlite3-database=/var/lib/powerdns/pdns.sqlite3 gsqlite3-dnssec=yes Then,\n# Initialize the sqlite database with schema sudo sqlite3 /var/lib/powerdns/pdns.sqlite3 # Change ownership of the directory to the `pdns` user and group sudo chown -R pdns:pdns /var/lib/powerdns # Restart PowerDNS sudo systemctl restart pdns Make sure there are no errors and the server is running with\nsudo systemctl status pdns At this point, the DNS server is set up and we can add our domain’s zone!\nCreate zone A zone is a collection of records belonging to a specific namespace, in this case, our domain. All records will be added to this new zone that’s going to be created.\n Remember to replace smartface with your Handshake domain\n # create an empty zone sudo -u pdns pdnsutil create-zone smartface ns1.smartface # enable DNSSEC for the zone sudo -u pdns pdnsutil secure-zone smartface # add a TXT record so we can test the DNS server # Name: @ (root of domain) # Type: TXT # Value: \"first-record!\" (note the single quotes to make bash pass in the double quotes) sudo -u pdns pdnsutil add-record smartface. @ TXT '\"first-record!\"' Now try to query the server with dig and you should see the TXT record in the response!\ndig @127.0.0.1 smartface TXT +dnssec  Instead of 127.0.0.1, you can even try it with the public IP address of the machine\n Point domain to DNS server We’ll set some DNS records on the blockchain that says “contact DNS Server for records on how to reach content”.\nThe NS record is for pointing to the DNS server, and the other is a DS record that completes the chain of trust for DNSSEC.\nTo get the DS record value to add, type in pdnsutil show-zone smartface and it should show a list of keys like:\nkeys: ID = 1 (CSK), flags = 257, tag = 16580, algo = 13, bits = 256 Active Published ( ECDSAP256SHA256 ) CSK DNSKEY = smartface. IN DNSKEY 257 3 13 BmMMTshK2sZmsZwIiX9J0DATWzxN4NJcQnC6/PbRMPHVNh4UrA2RDRY316KTDZCE8dloHiVncH+wK8a6NsoAyw== ; ( ECDSAP256SHA256 ) DS = smartface. IN DS 16580 13 1 68280939f0acdb13defda2080a7865e601159e72 ; ( SHA1 digest ) DS = smartface. IN DS 16580 13 2 97476c53a660b47e8a68da6f6365e87016cd044d2638e33561149203eaf95e75 ; ( SHA256 digest ) DS = smartface. IN DS 16580 13 4 802f39144574b60e4a20b9dcb8e539fb541630153bc236b89cf733c0d8482d72bc2cde8a381b97a9e812df45193ae5e6 ; ( SHA-384 digest ) We only need one of these rows. While we could take any one of the DS rows, SHA256 is good enough (the 2nd last line with “13 2” in it).\nWe now have all the info that’s needed to add records on the blockchain.\n The IP address in the images below must be replaced with your machine’s public IP address.\n Namebase If you’re using Namebase, then update the Blockchain DNS to look like this: Bob Wallet The NS record can only take hostnames, not IP addresses. One way around this is to create a glue record on the domain that points ns1.smartface - 20.106.52.247 and then use that as the value for the NS record. Don’t worry if you don’t completely get it, it’s just a hack to set an IP address for the NS record.\nSo with Bob Wallet (or any other wallet), a GLUE record must explicitly be added:  Note the trailing dot required for the NS record here.\n Wait. Updates to blockchain DNS are not instantaneous. Handshake stores this data in a structure called Urkel Tree, which only updates 4 times a day (every ~6 hours) to save on space and improve performance.\n This is fine because the blockchain is meant to be referral-only and should not change frequently. Any DNS record changes (subdomains, etc.) will be done on PowerDNS directly and will be much faster (with a default TTL of 5 minutes).\n This tree update takes place at every 36 blocks, so to get an approximate time when you can expect the changes to go live would be:\nlast_update = (current height % 36) blocks ago next_update = (36 - last_update) blocks to go Practically, you might need to wait for another block or three.\nQuery a public handshake resolver (https://hdns.io in this case) for the TXT record:\ndig @103.196.38.38 smartface TXT +dnssec If the tree update is done, and everything’s well, you should see the TXT record response from the DNS server!\nWith the DNS server set up, let’s move on to Part 2: Set up the Web server.\n","wordCount":"1057","inLanguage":"en","datePublished":"2021-11-26T00:00:00+05:30","dateModified":"2021-11-26T00:00:00+05:30","author":[{"@type":"Person","name":"Rithvik Vibhu"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.htools.work/posts/hns-pdns-nginx-part-1/"},"publisher":{"@type":"Organization","name":"Handshake Tools Blog","logo":{"@type":"ImageObject","url":"https://blog.htools.work/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.htools.work/ accesskey=h title="Handshake Tools Blog (Alt + H)">Handshake Tools Blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://blog.htools.work/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://blog.htools.work/>Home</a>&nbsp;»&nbsp;<a href=https://blog.htools.work/posts/>Posts</a></div>
<h1 class=post-title>
HNS + PowerDNS + Nginx + DANE - Part 1
</h1>
<div class=post-meta><span title="2021-11-26 00:00:00 +0530 +0530">November 26, 2021</span>&nbsp;·&nbsp;Rithvik Vibhu
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#set-up-dns-server aria-label="Set up DNS server">Set up DNS server</a><ul>
<li>
<a href=#disable-stub-resolver aria-label="Disable Stub Resolver">Disable Stub Resolver</a></li>
<li>
<a href=#install-powerdns aria-label="Install PowerDNS">Install PowerDNS</a></li>
<li>
<a href=#configure-powerdns aria-label="Configure PowerDNS">Configure PowerDNS</a></li>
<li>
<a href=#create-zone aria-label="Create zone">Create zone</a></li>
<li>
<a href=#point-domain-to-dns-server aria-label="Point domain to DNS server">Point domain to DNS server</a><ul>
<li>
<a href=#namebase aria-label=Namebase>Namebase</a></li>
<li>
<a href=#bob-wallet aria-label="Bob Wallet">Bob Wallet</a></li></ul>
</li>
<li>
<a href=#wait aria-label=Wait.>Wait.</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><strong>Posts in this series:</strong></p>
<ol>
<li><a href=https://blog.htools.work/posts/hns-pdns-nginx/>Introduction</a></li>
<li>Part 1 - Set up DNS server (this one!)</li>
<li><a href=https://blog.htools.work/posts/hns-pdns-nginx-part-2/>Part 2 - Set up Web server</a></li>
<li><a href=https://blog.htools.work/posts/hns-pdns-nginx-part-3/>Part 3 - Secure with DANE</a></li>
</ol>
<hr>
<h1 id=set-up-dns-server>Set up DNS server<a hidden class=anchor aria-hidden=true href=#set-up-dns-server>#</a></h1>
<p>We&rsquo;ll be using PowerDNS here. You can use
<a href=https://www.digitalocean.com/community/tutorials/how-to-setup-dnssec-on-an-authoritative-bind-dns-server-2>bind9</a>,
<a href=https://www.knot-dns.cz/docs/2.4/singlehtml/>knot</a>, or any other
authoritative server, but PowerDNS is the (personally) easiest to set up and
use.</p>
<blockquote>
<p>Sebastian Rasor has a similar guide with <code>nsd</code>: <a href=https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane>https://www.sebastianrasor.com/blog/hosting-a-secure-website-on-the-handshake-protocol-using-dane</a></p>
</blockquote>
<h2 id=disable-stub-resolver>Disable Stub Resolver<a hidden class=anchor aria-hidden=true href=#disable-stub-resolver>#</a></h2>
<p>First things first, Ubuntu comes with systemd&rsquo;s stub resolver listening on port
53, which we&rsquo;ll need to stop / free up.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># check if the DNS port is already bound to by systemd-resolve</span>
sudo lsof -i :53
<span style=color:#75715e># if the output is empty, the stub resolver is already disabled, skip this section.</span>
</code></pre></div><p>With your favorite text editor, open <code>/etc/systemd/resolved.conf</code> with sudo and:</p>
<ol>
<li>Set <code>DNS=1.1.1.1</code> (or any other public resolver to be used by the system)</li>
<li>Uncomment and set <code>DNSStubListener=no</code></li>
</ol>
<p>Symlink this file to use systemd&rsquo;s resolv config:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre></div><p>Then reboot the machine with <code>sudo reboot</code>. Check with <code>lsof</code> again and make
sure <code>systemd-resolve</code> is not listed.</p>
<blockquote>
<p>If you see sudo <del>complaining</del> warning about hostname not resolving every
time it is used, edit <code>/etc/hosts</code> to add a line <code>127.0.0.1 hostname</code> where
hostname is the hostname of the machine. This won&rsquo;t affect any commands below
and is entirely optional.</p>
</blockquote>
<h2 id=install-powerdns>Install PowerDNS<a hidden class=anchor aria-hidden=true href=#install-powerdns>#</a></h2>
<p>This is straight-forward and same as <a href=https://doc.powerdns.com/authoritative/installation.html>PowerDNS install
docs</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># Add PowerDNS repo from https://repo.powerdns.com/ (select OS, Authoritative Server, latest version)</span>
sudo sh -c <span style=color:#e6db74>&#34;echo &#39;deb [arch=amd64] http://repo.powerdns.com/ubuntu focal-auth-46 main&#39; &gt; /etc/apt/sources.list.d/pdns.list&#34;</span>
sudo sh -c <span style=color:#e6db74>&#34;echo &#39;Package: pdns-*\nPin: origin repo.powerdns.com\nPin-Priority: 600&#39; &gt; /etc/apt/preferences.d/pdns&#34;</span>
curl https://repo.powerdns.com/FD380FBB-pub.asc | sudo apt-key add -
sudo apt update

<span style=color:#75715e># Install PowerDNS and sqlite3 backend (which is good enough for most cases)</span>
sudo apt install sqlite3 pdns-server pdns-backend-sqlite3 -y
</code></pre></div><p>The server must have started by now, confirm that the <code>Active:</code> is
<code>active(running)</code> in green on</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo systemctl status pdns
</code></pre></div><h2 id=configure-powerdns>Configure PowerDNS<a hidden class=anchor aria-hidden=true href=#configure-powerdns>#</a></h2>
<p>With the server now installed, we&rsquo;ll update its configuration file
<code>/etc/powerdns/pdns.conf</code> and set these fields:</p>
<p>(remember to remove the existing <code>launch</code> line in the file)</p>
<pre tabindex=0><code>launch=gsqlite3
gsqlite3-database=/var/lib/powerdns/pdns.sqlite3
gsqlite3-dnssec=yes
</code></pre><p>Then,</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># Initialize the sqlite database with schema</span>
sudo sqlite3 /var/lib/powerdns/pdns.sqlite3 &lt; /usr/share/doc/pdns-backend-sqlite3/schema.sqlite3.sql

<span style=color:#75715e># Change ownership of the directory to the `pdns` user and group</span>
sudo chown -R pdns:pdns /var/lib/powerdns

<span style=color:#75715e># Restart PowerDNS</span>
sudo systemctl restart pdns
</code></pre></div><p>Make sure there are no errors and the server is running with</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo systemctl status pdns
</code></pre></div><p>At this point, the DNS server is set up and we can add our domain&rsquo;s zone!</p>
<h2 id=create-zone>Create zone<a hidden class=anchor aria-hidden=true href=#create-zone>#</a></h2>
<p>A zone is a collection of records belonging to a specific namespace,
in this case, our domain. All records will be added to this new zone that&rsquo;s
going to be created.</p>
<blockquote>
<p>Remember to replace <code>smartface</code> with your Handshake domain</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># create an empty zone</span>
sudo -u pdns pdnsutil create-zone smartface ns1.smartface

<span style=color:#75715e># enable DNSSEC for the zone</span>
sudo -u pdns pdnsutil secure-zone smartface

<span style=color:#75715e># add a TXT record so we can test the DNS server</span>
<span style=color:#75715e># Name: @ (root of domain)</span>
<span style=color:#75715e># Type: TXT</span>
<span style=color:#75715e># Value: &#34;first-record!&#34; (note the single quotes to make bash pass in the double quotes)</span>
sudo -u pdns pdnsutil add-record smartface. @ TXT <span style=color:#e6db74>&#39;&#34;first-record!&#34;&#39;</span>
</code></pre></div><p>Now try to query the server with <code>dig</code> and you should see the TXT record in the
response!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>dig @127.0.0.1 smartface TXT +dnssec
</code></pre></div><blockquote>
<p>Instead of 127.0.0.1, you can even try it with the public IP address of the
machine</p>
</blockquote>
<h2 id=point-domain-to-dns-server>Point domain to DNS server<a hidden class=anchor aria-hidden=true href=#point-domain-to-dns-server>#</a></h2>
<p>We&rsquo;ll set some DNS records on the blockchain that says &ldquo;contact <code>DNS Server</code> for
records on how to reach content&rdquo;.</p>
<p>The NS record is for pointing to the DNS server, and the other is a DS record that
completes the chain of trust for DNSSEC.</p>
<p>To get the DS record value to add, type in <code>pdnsutil show-zone smartface</code> and it
should show a list of keys like:</p>
<pre tabindex=0><code>keys:
ID = 1 (CSK), flags = 257, tag = 16580, algo = 13, bits = 256     Active         Published  ( ECDSAP256SHA256 )
CSK DNSKEY = smartface. IN DNSKEY 257 3 13 BmMMTshK2sZmsZwIiX9J0DATWzxN4NJcQnC6/PbRMPHVNh4UrA2RDRY316KTDZCE8dloHiVncH+wK8a6NsoAyw== ; ( ECDSAP256SHA256 )
DS = smartface. IN DS 16580 13 1 68280939f0acdb13defda2080a7865e601159e72 ; ( SHA1 digest )
DS = smartface. IN DS 16580 13 2 97476c53a660b47e8a68da6f6365e87016cd044d2638e33561149203eaf95e75 ; ( SHA256 digest )
DS = smartface. IN DS 16580 13 4 802f39144574b60e4a20b9dcb8e539fb541630153bc236b89cf733c0d8482d72bc2cde8a381b97a9e812df45193ae5e6 ; ( SHA-384 digest )
</code></pre><p>We only need one of these rows. While we could take any one of the DS rows,
SHA256 is good enough (the 2nd last line with &ldquo;13 2&rdquo; in it).</p>
<p>We now have all the info that&rsquo;s needed to add records on the blockchain.</p>
<blockquote>
<p>The IP address in the images below must be replaced with your machine&rsquo;s public
IP address.</p>
</blockquote>
<h3 id=namebase>Namebase<a hidden class=anchor aria-hidden=true href=#namebase>#</a></h3>
<p>If you&rsquo;re using Namebase, then update the Blockchain DNS to look like this:
<img loading=lazy src=images/namebase_blockchain_dns.png alt="Namebase Blockchain DNS">
</p>
<h3 id=bob-wallet>Bob Wallet<a hidden class=anchor aria-hidden=true href=#bob-wallet>#</a></h3>
<p>The NS record can only take hostnames, not IP addresses. One way around this is
to create a glue record on the domain that points <code>ns1.smartface</code> ->
<code>20.106.52.247</code> and then use that as the value for the NS record. Don&rsquo;t worry if
you don&rsquo;t completely get it, it&rsquo;s just a hack to set an IP address for the NS
record.</p>
<p>So with Bob Wallet (or any other wallet), a GLUE record must explicitly be
added: <img loading=lazy src=images/bob_blockchain_dns.png alt="Bob Blockchain DNS">
</p>
<blockquote>
<p>Note the trailing dot required for the NS record here.</p>
</blockquote>
<h2 id=wait>Wait.<a hidden class=anchor aria-hidden=true href=#wait>#</a></h2>
<p>Updates to blockchain DNS are not instantaneous. Handshake stores this data in a
structure called Urkel Tree, which only updates 4 times a day (every ~6 hours)
to save on space and improve performance.</p>
<blockquote>
<p>This is fine because the blockchain is meant to be referral-only and
should not change frequently. Any DNS record changes (subdomains, etc.) will
be done on PowerDNS directly and will be much faster (with a default TTL of 5
minutes).</p>
</blockquote>
<p>This tree update takes place at every 36 blocks, so to get an approximate time
when you can expect the changes to go live would be:</p>
<pre tabindex=0><code>last_update = (current height % 36) blocks ago
next_update = (36 - last_update) blocks to go
</code></pre><p>Practically, you might need to wait for another block or three.</p>
<p>Query a public handshake resolver (<a href=https://hdns.io>https://hdns.io</a> in this case) for the TXT
record:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>dig @103.196.38.38 smartface TXT +dnssec
</code></pre></div><p>If the tree update is done, and everything&rsquo;s well, you should see the TXT record
response from the DNS server!</p>
<p>With the DNS server set up, let&rsquo;s move on to <a href=https://blog.htools.work/posts/hns-pdns-nginx-part-2/>Part 2: Set up the Web
server</a>.</p>
</div>
<footer class=post-footer>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on twitter" href="https://twitter.com/intent/tweet/?text=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201&url=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f&title=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201&summary=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201&source=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f&title=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on whatsapp" href="https://api.whatsapp.com/send?text=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201%20-%20https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HNS + PowerDNS + Nginx + DANE - Part 1 on telegram" href="https://telegram.me/share/url?text=HNS%20%2b%20PowerDNS%20%2b%20Nginx%20%2b%20DANE%20-%20Part%201&url=https%3a%2f%2fblog.htools.work%2fposts%2fhns-pdns-nginx-part-1%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://blog.htools.work/>Handshake Tools Blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>const comment="Google Analytics (I know, sorry, just until I set up a self-hosted alternative)";(function(a,m,b){var d=a.history,c=document,f=navigator||{},g=localStorage,h=encodeURIComponent,i=d.pushState,j=function(){return Math.random().toString(36)},k=function(){return g.cid||(g.cid=j()),g.cid},l=function(a){var c=[],b;for(b in a)a.hasOwnProperty(b)&&void 0!==a[b]&&c.push(h(b)+"="+h(a[b]));return c.join("&")},e=function(n,o,p,q,i,j,d){var e="https://www.google-analytics.com/collect",g=l({v:"1",ds:"web",aip:b.anonymizeIp?1:void 0,tid:m,cid:k(),t:n||"pageview",sd:b.colorDepth&&screen.colorDepth?screen.colorDepth+"-bits":void 0,dr:c.referrer||void 0,dt:c.title,dl:c.location.origin+c.location.pathname+c.location.search,ul:b.language?(f.language||"").toLowerCase():void 0,de:b.characterSet?c.characterSet:void 0,sr:b.screenSize?(a.screen||{}).width+"x"+(a.screen||{}).height:void 0,vp:b.screenSize&&a.visualViewport?(a.visualViewport||{}).width+"x"+(a.visualViewport||{}).height:void 0,ec:o||void 0,ea:p||void 0,el:q||void 0,ev:i||void 0,exd:j||void 0,exf:"undefined"!=typeof d&&!1==!!d?0:void 0}),h;f.sendBeacon?f.sendBeacon(e,g):(h=new XMLHttpRequest,h.open("POST",e,!0),h.send(g))};d.pushState=function(a){return"function"==typeof d.onpushstate&&d.onpushstate({state:a}),setTimeout(e,b.delay||10),i.apply(d,arguments)},e(),a.ma={trackEvent:function(a,b,c,d){return e("event",a,b,c,d)},trackException:function(a,b){return e("exception",null,null,null,null,a,b)}}})(window,"UA-214306612-1",{anonymizeIp:!0,colorDepth:!0,characterSet:!0,screenSize:!0,language:!0})</script>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>